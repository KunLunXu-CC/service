# 基础镜像: 表示在 ubuntu 镜像基础上进行扩展
FROM ubuntu

RUN rm /bin/sh && ln -s /bin/bash /bin/sh

# 创建工作目录
RUN mkdir /var/service

# 安装基本工具: wget、git、
RUN apt-get update && \
  apt-get install wget -y && \
  apt-get install git -y && \
  apt-get install build-essential libssl-dev -y && \
  apt-get install --assume-yes apt-utils -y

# 安装 nvm
RUN wget https://raw.githubusercontent.com/nvm-sh/nvm/v0.36.0/install.sh | bash

# nvm
RUN echo 'export NVM_DIR="$HOME/.nvm"'                                       >> "$HOME/.bashrc"
RUN echo '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm' >> "$HOME/.bashrc"
RUN echo '[ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion" # This loads nvm bash_completion' >> "$HOME/.bashrc"

# nodejs and tools
RUN bash -c 'source $HOME/.nvm/nvm.sh   && \
    nvm install node                    && \
    npm install -g doctoc urchin eclint dockerfile_lint && \
    npm install --prefix "$HOME/.nvm/"'

RUN nvm install node
RUN nvm alias default node

# 安装 netcat: 网络测试工具, 用于检测 mongo 容器运行状态
RUN apt-get -q update && apt-get -qy install netcat

# 拷贝脚本监听 mongo 容器
COPY ./waitfor.sh /shell/waitfor.sh
RUN chmod +x /shell/*

# 设置工作目录
WORKDIR /var/service

# 设置挂载点
VOLUME [/var/service]

# 对外暴露端口
EXPOSE 4000

# 容器启动时执行指令: 指定新建容器在每次运行时需要执行的命令
CMD /bin/bash
