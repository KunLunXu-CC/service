# 基础镜像: 表示在 ubuntu 镜像基础上进行扩展
FROM ubuntu

# 用 bash 替换 shell
RUN rm /bin/sh && ln -s /bin/bash /bin/sh

# 创建工作目录
RUN mkdir /var/service

# 设置环境变量: NVM_DIR、NODE_VERSION
ENV NVM_DIR /usr/local/nvm
ENV NODE_VERSION 15.0.1

# 更新、安装工具
RUN apt-get update --fix-missing \
  && apt-get install -y curl \
  && apt-get install -y git \
  && apt-get install -y build-essential libssl-dev

# 安装 nvm、node、npm
RUN curl https://raw.githubusercontent.com/creationix/nvm/v0.30.1/install.sh | bash \
    && . $NVM_DIR/nvm.sh \
    && nvm install $NODE_VERSION \
    && nvm alias default $NODE_VERSION \
    && nvm use default
ENV NODE_PATH $NVM_DIR/v$NODE_VERSION/lib/node_modules
ENV PATH      $NVM_DIR/v$NODE_VERSION/bin:$PATH

# 安装 netcat: 网络测试工具, 用于检测 mongo 容器运行状态
RUN apt-get -q update && apt-get -qy install netcat

# 拷贝脚本监听 mongo 容器
COPY ./waitfor.sh /shell/waitfor.sh
RUN chmod +x /shell/*

# 设置工作目录
WORKDIR /var/service

# 设置挂载点
VOLUME [/var/service]

# 对外暴露端口
EXPOSE 4000

# 容器启动时执行指令: 指定新建容器在每次运行时需要执行的命令
CMD /bin/bash
