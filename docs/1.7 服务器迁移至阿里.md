# 服务器迁移阿里记录

## 一、 服务器购买

### 1.1 登陆阿里云

### 1.2 购买轻量应用服务器

地区: 香港(为了躲避备案)
镜像: ubuntu18.04
套餐: CPU 1核、内存 2G、SSD 50G、限峰值带宽 30mbps、每月流量 2T

## 二、 为 root 设置秘钥、并配置 SSH

### 2.1 设置 root 密码

1. 进入: 控制台 --> 服务器列表 --> 选择远程连接
2. 设置 root 密码

```sh
sudo passwd root
# 设置 root 密码
```

### 2.2 本地 ssh 连接至服务器

```sh
# 使用 root shh 到服务器
sudo ssh root@服务器公网IP
```

### 2.3 为 root 用户创建私钥对实现秘钥登陆

- 秘钥生成和拷贝

```shell
# 【服务器】创建秘钥对: 一路回车就行
ssh-keygen -b 1024 -t rsa

# 【服务器】设置秘钥秘钥的权限(方便后面的拷贝)
chmod 777 -R ~/.ssh/

# 【本地】执行 scp 拷贝私钥到本地
sudo scp root@服务器公网IP:~/.ssh/id_rsa <本地存储拷贝秘钥路径>

# 【本地】设置秘钥权限, 权限不能太高, 太高登陆不了
sudo chmod 600 <本地存储拷贝秘钥路径>

# 【服务器】设置秘钥目录权限
chmod 700 ~/.ssh/ && cd ~/.ssh/

# 【服务器】修改秘钥名称和权限, 秘钥权限不能太高
mv id_rsa.pub authorized_keys && chmod 600 authorized_keys
```

- 服务器 ssh 配置: 使用秘钥登陆、禁止密码登陆

```sh
# 1. 编辑配置文件: 添加下面配置内容
vim /etc/ssh/sshd_config

  # 1.1 允许 root 登陆配置
  PermitRootLogin yes

  # 1.2 密码登陆配置: 启停
  PasswordAuthentication no

  # 1.3 秘钥登陆配置: 启停
  PubkeyAuthentication yes

# 2. 重启 SSH
service sshd restart
```

- 验证: 本地 ssh 登陆服务器

```sh
# 密码登陆
sudo ssh root@服务器IP
root@服务器IP: Permission denied (publickey).

# 秘钥登陆
sudo ssh -i <本地存储拷贝秘钥路径> root@服务器IP
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-48-generic x86_64)
```

## 三、 新增用户(lh)、并设置秘钥(SSH登陆用)

### 3.1 创建新用户 lh 并设置密码同时添加至管理员列表(允许使用 sudo)

```sh
# 新增用户 lh: -rms 是 -r -m -s 简写
# -r 表示建立系统账号 -m 表示自动建立用户的登入目录 -s 表示指定用户登入后所使用的 shell
sudo useradd -rms /bin/bash lh

# 设置用户 lh 密码
sudo passwd lh

# 为当前用户添加对 /etc/sudoers 可写的权限
sudo chmod +w /etc/sudoers

# 编辑 /etc/sudoers 为 lh 设置权限
sudo vim /etc/sudoers

# 修改 /etc/sudoers 内容: 在 root 下新增一行
root　ALL=(ALL:ALL) ALL
lh    ALL=(ALL:ALL) ALL

# 移除当前用户对  /etc/sudoers 的可写权限
sudo chmod -w /etc/sudoers
```

### 3.2 为 lh 设置秘钥, 实现秘钥登陆

```sh
# 切换用户
su lh

# 【服务器】创建秘钥对: 一路回车就行
ssh-keygen -b 1024 -t rsa

# 【服务器】设置秘钥秘钥的权限(方便后面的拷贝)
chmod 777 -R ~/.ssh/

# 【本地】执行 scp 拷贝私钥到本地
sudo scp -i <root用户登陆秘钥> root@服务器公网IP:/home/lh/.ssh/id_rsa <本地存储拷贝秘钥路径>

# 【本地】设置秘钥权限, 权限不能太高, 太高登陆不了
sudo chmod 600 <本地存储拷贝秘钥路径>

# 【服务器】设置秘钥目录权限
chmod 700 ~/.ssh/ && cd ~/.ssh/

# 【服务器】修改秘钥名称和权限, 秘钥权限不能太高
mv id_rsa.pub authorized_keys && chmod 600 authorized_keys
```

### 3.3 新用户(lh)ssh登陆

```sh
sudo ssh -i <本地存储拷贝秘钥路径> lh@服务器IP
```

## 四、 环境搭建

### 4.1 安装 git

```shell
sudo apt-get update
sudo apt-get install git -y
```

```shell
# 配置用户信息
git config --global user.email qianyin95@qq.com
git config --global user.name qianyin925
```

### 4.2 安装 docker

[官网](https://docs.docker.com/install/linux/docker-ce/ubuntu/)

- docker 安装

```shell
#  卸载旧包
sudo apt-get remove docker docker-engine docker.io containerd runc

#  更新库
sudo apt-get update

#  安装依赖
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

# 添加官方GPG密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo apt-key fingerprint 0EBFCD88

#  添加储存库
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"

#  更新
sudo apt-get update

#  安装
sudo apt-get install docker-ce docker-ce-cli containerd.io
```

- 设置国内源

登录[阿里容器镜像服务](https://cr.console.aliyun.com/cn-beijing/instances/mirrors)

复制加速器地址, 并编辑内容

```sh
sudo vim /etc/docker/daemon.json
```

输入以下内容

{
  "registry-mirrors": ["加速器地址"]
}

重启

```sh
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 2.3 docker-compose 安装

[官网](https://docs.docker.com/compose/install/)

```shell
# 运行此命令以下载Docker Compose的当前稳定版本：
# 或者本地进入 https://github.com/docker/compose 下载指定版本的二进制文件并上传至 /usr/local/bin/docker-compose
sudo curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
# 对二进制文件应用可执行权限：
sudo chmod +x /usr/local/bin/docker-compose
```

### 4.4 安装 nvm

[github](https://github.com/creationix/nvm/blob/master/README.md)

```shell
# 下载: 或者手动创建并复制 shll 脚本后执行: 下面版本可能不是最新的
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash

# 编辑 .bashrc 修改下面内容
sudo vim ~/.bashrc

# 修改前
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# 修改后
export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm

# 重新加载 bashrc
source ~/.bashrc

# 安装指定版本 node: 最新版本请在到 node 官网查询
nvm install v12.16.1

# 始终默认为 shell 使用最新版本
nvm alias default node

# 设置淘宝源
npm config set registry https://registry.npm.taobao.org/
```


## 五、备份数据

- ssh 登录原服务器, 并拷贝数据

```sh
# 1. 容器内备份数据库
sudo docker exec blog-mongo sh -c 'mongodump -d blog -o /mongo-bak'

# 2. 拷贝容器内数据到宿主机器
sudo docker cp blog-mongo:/mongo-bak/blog 备份路径/mongo-bak
```

- 使用 scp 将数据拷贝到本地

```sh
sudo scp -i ~/.ssh/login_qianyin -r qianyin@www.qianyin925.com:/mongo-bak ./mongo-bak
```

## 六、 迁移域名

1. 进入腾讯云域名管理列表
2. 在要转移域名列表操作栏点击管理
3. 页面拉到最后选择转出域名
4. 进入阿里云控制台 --> 域名 --> 转入域名 --> 选择我要转入域名
5. 根据提示完成域名转移(还是需要一个过程的)

## 七、 项目部署

### 7.1 服务端项目部署

- 克隆项目

```shell
# 克隆 service 端
git clone https://github.com/qianyin925/blog_service.git blog
```

- 进入项目

```shell
cd blog
```

- git 忽略权限更改

```shell
git config core.filemode false
```

- 安装依赖

```shell
npm i
```

- 创建秘钥

```shell
npm run gulp createSecretKey
```

- 创建配置文件 production.js: 基于 config/system/development.js 进行创建修改

```shell
# 进入配置目录
cd config/system/

# 复制 development.js 为 production.js
cp development.js production.js

# 编辑配置文件 production.js
vim production.js
```

- 创建 ssl 证书 docker/nginx/ssl.crt 以及对应秘钥 docker/nginx/ssl.key

### 7.2 客户端部署

- 克隆 client 端项目至 nginx/html

```shell
cd ../../ && mkdir html
git clone https://github.com/qianyin925/blog_client.git html
```

- 安装依赖并编译代码

```shell
# 进入项目
cd html

# git 忽略权限更改
git config core.filemode false

# 安装依赖
npm i

# 编译包
npm run build

# 拷贝编译后的文件: docker nginx 根目录为 html/dist
mkdir dist && cp -r build/* dist/
```

### 7.3 运行项目

- 执行 docker-compose

```shell
cd ../docker/ && sudo docker-compose up -d

# 设置目录权限
sudo chmod -R 777 .
```

### 7.4 导入数据

```shell
# 1. 使用 scp 将数据备份上传至新服务器

sudo scp -i <用户秘钥路径> -r ./mongo-bak lh@服务器IP:~/mongo-bak

# 2. 拷贝备份文件到容器内: mongo-bak 是个文件夹(tar包不懂信不信未测试))
sudo docker cp 备份路径/mongo-bak blog-mongo:/mongo-bak

# 3. 恢复数据库
sudo docker exec blog-mongo sh -c 'mongorestore -d blog --drop /mongo-bak'

# 4. 删除容器内备份
sudo docker exec blog-mongo sh -c 'rm -rf /mongo-bak'

# 5. 删除本地备份文件
sudo rm -rf 备份路径/mongo-bak
```
