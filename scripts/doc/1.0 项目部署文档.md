# 项目从零部署

## 一、 云服务器(腾讯云)初期准备工作

- 登录腾讯云进入控制台找到云服务
- 购买域名、进行云解析、并对网站进行备案
- 重装系统并设置**秘钥**登录

## 二、 用户管理：新增用户(以 zh 为例)

- 使用默认用户登录

```shell
# -i 指定秘钥路径
sudo ssh -i <本地默认用户秘钥路径> 默认用户用户名@www.qianyin925.com
```

- 创建新用户 zh 并设置密码同时添加至管理员列表

```shell
# 新增用户 zh: -r 建立系统账号 -m 自动建立用户的登入目录 -s 指定用户登入后所使用的shell
sudo useradd -r -m -s /bin/bash zh

# 设置用户 zh 密码
sudo passwd zh

# 为当前用户添加对 /etc/sudoers 可写的权限
sudo chmod +w /etc/sudoers

# 编辑 /etc/sudoers 为 zh 设置权限
sudo vim /etc/sudoers

# 修改 /etc/sudoers 内容为: 在 root 下新增一行
root　ALL=(ALL:ALL) ALL
zh    ALL=(ALL:ALL) ALL

# 移除当前用户对  /etc/sudoers 的可写权限
sudo chmod -w /etc/sudoers
```

- 为 zh 设置秘钥, 实现秘钥登录

```shell
# 切换用户
su zh

# 服务器创建秘钥对
ssh-keygen -b 1024 -t rsa

# 服务器设置秘钥秘钥的权限(方便后面的拷贝)
chmod 777 -R /home/zh/.ssh/

# 本地执行 scp 拷贝私钥 /home/zh/.ssh/id_rsa 到本地
sudo scp -i <本地默认用户秘钥路径> 默认用户用户名@www.qianyin925.com:/home/zh/.ssh/id_rsa <本地存储拷贝秘钥路径>

# 设置本地秘钥权限, 权限不能太高, 太高登录不了
sudo chmod 600 <本地存储拷贝秘钥路径>

# 服务器设置秘钥目录权限、修改秘钥名称和权限, 秘钥权限不能太高
chmod 700 /home/zh/.ssh/
cd /home/zh/.ssh/
mv id_rsa.pub authorized_keys
chmod 600 authorized_keys

# 本地通过 zh 和对应秘钥登录
sudo ssh -i <本地存储拷贝秘钥路径> zh@www.qianyin925.com
```

## 二、 云服务器环境搭建

- 安装 git (腾讯云默认已有)

```shell
sudo apt-get update
sudo apt-get install git
```

```shell
# 配置用户信息
git config --global user.email qianyin95@qq.com
git config --global user.name qianyin925
```

- 安装 docker

[官网](https://docs.docker.com/install/linux/docker-ce/ubuntu/)

```shell
#  卸载旧包
sudo apt-get remove docker docker-engine docker.io containerd runc

#  更新库
sudo apt-get update

#  安装依赖
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

# 添加官方GPG密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo apt-key fingerprint 0EBFCD88

#  添加储存库
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"

#  更新
sudo apt-get update

#  安装
sudo apt-get install docker-ce docker-ce-cli containerd.io
```

设置国内源

登录[阿里容器镜像服务](https://cr.console.aliyun.com/cn-beijing/instances/mirrors) 

点击镜像加速器复制加速地址并安装下方文档进行配置

sudo vim /etc/docker/daemon.json

输入以下内容
{
  "registry-mirrors": ["https://49lr97vi.mirror.aliyuncs.com"]
}

sudo systemctl daemon-reload
sudo systemctl restart docker

- docker-compose 安装

[官网](https://docs.docker.com/compose/install/)

```shell
# 运行此命令以下载Docker Compose的当前稳定版本：
sudo curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
# 对二进制文件应用可执行权限：
sudo chmod +x /usr/local/bin/docker-compose
```

- 安装 nvm

[github](https://github.com/creationix/nvm/blob/master/README.md)

```shell
# 下载
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash

# 写入 .bashrc
export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm

# 重新加载 bashrc
source ~/.bashrc

# 安装指定版本 node
nvm install v12.6.0
```

## 三、 项目部署

- 创建项目存储目录并进行该目录
- 克隆项目

```shell
# 克隆 client 端
sudo git clone https://github.com/qianyin925/blog_client.git

# 克隆 service 端
sudo git clone https://github.com/qianyin925/blog_service.git
```

- 进入 service 端安装依赖

```shell
cd blog_service && npm i
```

- 进入 client 端并安装依赖

```shell
cd blog_client && npm i
```
